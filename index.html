<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link href="assets/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="assets/css/simple-line-icons.css" rel="stylesheet" type="text/css">
  <link href="assets/css/bootstrap-toggle.min.css" rel="stylesheet" type="text/css">
  <link href="assets/css/ui-overlay.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.css" />
  <style>
    body { width: 300px; padding: 0; margin: 0; }
    .card { border-radius: 0; }
    .overlay { display: none; }
  </style>
</head>

<body>
  <div class="card text-white bg-dark mb-0" style="width: 300px;">
    <div class="card-header">
      <h5 class="card-title">Tasks Rewards Bot - Chrome v<span id="ExtensionVersion"></span></h5>
    </div>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item flex-fill">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home-tab-info" role="tab"
          aria-controls="home-tab-info" aria-selected="true"><span id="main_nav">Main</span></a>
      </li>
      <li class="nav-item flex-fill">
        <a class="nav-link" id="tab-settings" data-toggle="tab" href="#tab-settings-info" role="tab"
          aria-controls="tab-settings-info" aria-selected="false">Settings</a>
      </li>
    </ul>
    <div class="card-body">
      <div class="overlay" id="overlay">
        <div class="overlay__inner">
          <div class="overlay__content"><span class="spinner"></span></div>
        </div>
      </div>

      <div class="tab-content">
        <!-- TAB: Main -->
        <div class="tab-pane active" id="home-tab-info" role="tabpanel" aria-labelledby="home-tab">
          <div id="home-tab-msg">

            <!-- Login Form -->
            <div id="login_form" class="text-center">
              <div class="form-group mb-3">
                <input type="text" id="user_id_input" class="form-control" placeholder="Enter your User ID">
              </div>
              <button id="save_user_id" class="btn btn-primary w-100">Login</button>
            </div>

            <!-- User Info (shown after login) -->
            <div id="userinfo" style="display:none;">
              <ul class="list-group bg-dark">
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark">
                  <b class="simple-icon-user"> User ID</b>
                  <span id="username" class="text-primary"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark">
                  <b class="simple-icon-cup"> Coins</b>
                  <span id="coins" class="text-info">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark">
                  <b class="simple-icon-wallet"> Balance</b>
                  <span id="balance" class="text-success">0.00</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center bg-dark">
                  <b class="simple-icon-rocket"> Membership</b>
                  <small id="membership" class="text-danger">Free</small>
                </li>
              </ul>
            </div>

          </div>
        </div>

        <!-- TAB: Settings -->
        <div class="tab-pane" id="tab-settings-info" role="tabpanel" aria-labelledby="tab-settings">
          <div id="tab-settings-msg" class="text-center">
            <div class="card">
              <div class="card-body">
                <h6 class="text-dark">Worker Settings</h6>
                <div class="form-group">
                  <input id="onlike" type="checkbox" checked data-toggle="toggle"
                    data-on="<i class='fa fa-thumbs-up'></i> ON"
                    data-off="<i class='fa fa-thumbs-up'></i> OFF" data-onstyle="success"
                    data-offstyle="danger" data-width="80">
                  <input id="onsubscribe" type="checkbox" checked data-toggle="toggle"
                    data-on="<i class='fa fa-user-plus'></i> ON"
                    data-off="<i class='fa fa-user-plus'></i> OFF" data-onstyle="success"
                    data-offstyle="danger" data-width="80">
                </div>
                <div class="form-group">
                  <input id="oncomment" type="checkbox" checked data-toggle="toggle"
                    data-on="<i class='fa fa-comment'></i> ON"
                    data-off="<i class='fa fa-comment'></i> OFF" data-onstyle="success"
                    data-offstyle="danger" data-width="80">
                  <input id="onlikecomment" type="checkbox" checked data-toggle="toggle"
                    data-on="<i class='fa fa-comments'></i> ON"
                    data-off="<i class='fa fa-comments'></i> OFF" data-onstyle="success"
                    data-offstyle="danger" data-width="80">
                </div>
                <small class="text-muted">Get more coins for every action</small>
              </div>
            </div>
          </div>
        </div>

      </div>

      <hr>
      <div id="logout" class="text-right" style="display:none;">
        <input id="start" type="button" value="Start Worker" class="btn btn-primary" />
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="assets/js/plugins/jquery-3.6.0.js"></script>
  <script src="assets/js/plugins/bootstrap.js"></script>
  <script src="assets/js/plugins/bootstrap-toggle.min.js"></script>
  <script src="assets/js/core/Main.js"></script>
  <script src="assets/js/core/Start.js"></script>
  <script src="assets/js/core/Human.js"></script>

  <script>
    // عرض إصدار الإضافة
    if (chrome.runtime && chrome.runtime.getManifest) {
      document.getElementById("ExtensionVersion").textContent = chrome.runtime.getManifest().version;
    }

    // عند تحميل الصفحة
    document.addEventListener("DOMContentLoaded", function () {
      // تحقق من وجود user_id محفوظ
      chrome.storage.local.get("user_id", (data) => {
        if (data.user_id) {
          loadUserProfile(data.user_id);
        }
      });

      // زر تسجيل الدخول
      document.getElementById("save_user_id").addEventListener("click", () => {
        const userId = document.getElementById("user_id_input").value.trim();
        if (!userId) {
          alert("Please enter a valid User ID");
          return;
        }
        loadUserProfile(userId);
      });

      // زر بدء العامل
      document.getElementById("start").addEventListener("click", () => {
        chrome.runtime.sendMessage({
          cmd: "openTab",
          url: "https://perceptive-victory-production.up.railway.app/worker/start"
        });
      });
    });

    // جلب بيانات المستخدم من الخادم
    function loadUserProfile(userId) {
      const overlay = document.getElementById("overlay");
      overlay.style.display = "block";

      fetch(`https://perceptive-victory-production.up.railway.app/api/user/profile?user_id=${encodeURIComponent(userId)}`)
        .then(res => res.json())
        .then(data => {
          overlay.style.display = "none";
          if (data.status === "success" && data.data) {
            // حفظ user_id
            chrome.storage.local.set({ user_id: userId });

            // عرض البيانات
            document.getElementById("username").textContent = data.data.fullname || userId;
            document.getElementById("coins").textContent = data.data.coins || 0;
            document.getElementById("balance").textContent = (data.data.balance || 0).toFixed(2);
            document.getElementById("membership").textContent = data.data.membership || "Free";

            // تبديل العرض
            document.getElementById("login_form").style.display = "none";
            document.getElementById("userinfo").style.display = "block";
            document.getElementById("logout").style.display = "block";
          } else {
            alert("Invalid User ID or server error");
          }
        })
        .catch(err => {
          overlay.style.display = "none";
          console.error("Failed to load user profile:", err);
          alert("Failed to connect to server");
        });
    }
  </script>
</body>

</html>
